* å®‰è£…æ–¹æ³•

1. ä¸‹è½½é…ç½®æ–‡ä»¶
   #+begin_src shell
     git clone https://github.com/xhcoding/.emacs.d.git ~/.emacs.d
   #+end_src
2. è¿è¡Œ org-tangle.bat å¯¼å‡ºé…ç½®åˆ° .el æ–‡ä»¶

3. å¯åŠ¨ emacs

* early-init.el
:PROPERTIES:
:HEADER-ARGS: :tangle early-init.el
:END:

Emacs å¯åŠ¨è¿‡ç¨‹çš„æ—©æœŸåŠ è½½ã€‚

#+begin_src elisp
  ;;; early-init.el --- early init  -*- lexical-binding: t no-byte-compile: t; -*-
#+end_src

** å°† gc çš„é˜ˆå€¼è®¾ç½®åˆ°æœ€å¤§ï¼Œé¿å…å¯åŠ¨çš„æ—¶å€™å¤šæ¬¡ gc æ‹–æ…¢å¯åŠ¨é€Ÿåº¦

#+begin_src elisp
  (setq gc-cons-threshold most-positive-fixnum)
#+end_src

** ä¸è¦åˆå§‹åŒ– package

#+begin_src elisp
  (setq package-enable-at-startup nil)
#+end_src

** ç¦æ­¢ frame ç¼©æ”¾

#+begin_src elisp
  (setq frame-inhibit-implied-resize t)
#+end_src

** å…³é—­èœå•æ 

#+begin_src elisp
  (push '(menu-bar-lines . 0) default-frame-alist)
#+end_src

** å…³é—­å·¥å…·æ 

#+begin_src elisp
  (push '(tool-bar-lines . 0) default-frame-alist)
#+end_src

** å…³é—­æ»šåŠ¨æ¡

#+begin_src elisp
  (push '(vertical-scroll-bars) default-frame-alist)
#+end_src

** å¯åŠ¨åå…¨å±

#+begin_src elisp
  (push '(fullscreen . fullscreen) default-frame-alist)
#+end_src

** straight åŒ…ç®¡ç†

#+begin_src elisp

  (defvar bootstrap-version)
  (let ((bootstrap-file
     (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
    (bootstrap-version 6))
    (unless (file-exists-p bootstrap-file)

      (with-current-buffer
      (url-retrieve-synchronously
       "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
       'silent 'inhibit-cookies)
    (goto-char (point-max))
    (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  (setq straight-vc-git-default-clone-depth 1)

#+end_src

** å¯åŠ¨é€Ÿåº¦æµ‹è¯•

#+begin_src elisp
(use-package benchmark-init
  :straight t
  :demand t
  :hook (after-init . benchmark-init/deactivate)
  :bind ("<f7>" . benchmark-init/show-durations-tree)
  )

#+end_src

* emacs é…ç½®
:PROPERTIES:
:HEADER-ARGS: :tangle init.el
:END:

#+begin_src elisp
  ;;; init.el --- init  -*- lexical-binding: t no-byte-compile: t; -*-
#+end_src

** è½½å…¥ custom æ–‡ä»¶

#+begin_src elisp
  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (load custom-file t)
#+end_src

** å®šä¹‰ä¸€äº›å›ºå®šçš„å¸¸é‡
#+begin_src elisp
  (defconst sys-is-windows (memq system-type '(cygwin windows-nt ms-dos)))

  ;; åŠ¨æ€åº“ç›®å½•
  (defconst my-lib-dir (expand-file-name "lib" user-emacs-directory))

  ;; å¤–éƒ¨é…ç½®æ–‡ä»¶ç›®å½•
  (defconst my-etc-dir (expand-file-name "etc" user-emacs-directory))

  ;; å­˜æ”¾ org æ–‡ä»¶çš„ç›®å½•
  (defconst my-org-dir (expand-file-name "~/Org/"))

  ;; ç§æœ‰æ–‡ä»¶ç›®å½•
  (defconst my-private-dir (expand-file-name "private" my-org-dir))

  ;; ç§æœ‰ä»£ç ç‰‡æ®µç›®å½•
  (defconst my-private-snippets-dir (expand-file-name "snippets" my-private-dir))

  ;; å­˜æ”¾ä»£ç çš„ç›®å½•
  (if sys-is-windows
      (defconst my-code-dir (expand-file-name "D:/Code"))
    (defconst my-code-dir (expand-file-name "~/Code")))

  ;; å­˜æ”¾ä¸€äº›å­˜æ¡£æ–‡ä»¶çš„ç›®å½•
  (if sys-is-windows
      (defconst my-archives-dir (expand-file-name "D:/Archives"))
    (defconst my-archives-dir (expand-file-name "~/Archives")))

#+end_src

** å¸¸ç”¨çš„å·¥å…·å‡½æ•°

*** é‡å‘½åå½“å‰æ–‡ä»¶

#+begin_src elisp
  (defun my/rename-this-file-and-buffer (new-name)
    "Rename both current buffer and file it's visiting to NEW_NAME."
    (interactive "sNew name: ")
    (let ((name (buffer-name))
          (filename (buffer-file-name)))
      (unless filename
        (error "Buffer '%s' is not visiting a file" name))
      (progn
        (when (file-exists-p filename)
          (rename-file filename new-name 1))
        (set-visited-file-name new-name)
        (rename-buffer new-name))))
#+end_src

*** åˆ é™¤å½“å‰æ–‡ä»¶

#+begin_src emacs-lisp
  (defun my/delete-file-and-buffer ()
    "Kill the current buffer and deletes the file it is visiting."
    (interactive)
    (let ((filename (buffer-file-name)))
      (when (and filename (y-or-n-p (concat "Do you really want to delete file " filename "?")))
        (delete-file filename t)
        (message "Deleted file %s." filename)
        (kill-buffer)
        )))
#+end_src

*** æ¸…ç† Message buffer

#+begin_src elisp
  (defun my/clear-messages-buffer ()
    "Clear *Messages* buffer."
    (interactive)
    (let ((inhibit-read-only t))
      (with-current-buffer "*Messages*"
        (erase-buffer))))
#+end_src

*** å¼€å…³ç½‘ç»œä»£ç†

#+begin_src elisp
  (defun my/toggle-url-proxy ()
    "Toggle proxy for the url.el library."
    (interactive)
    (require 'url)
    (cond
     (url-proxy-services
      (message "Turn off URL proxy")
      (setq url-proxy-services nil))
     (t
      (message "Turn on URL proxy")
      (setq url-proxy-services
            '(("http" . "localhost:58591")
              ("https" . "localhost:58591")
              ("no_proxy" . "0.0.0.0"))))))


#+end_src

*** æ¸…ç†æ‰æ²¡ç”¨çš„ buffer

#+begin_src elisp
  (defun my/kill-unused-buffers ()
    "Kill unused buffers."
    (interactive)
    (ignore-errors
      (save-excursion
        (dolist (buf (buffer-list))
          (set-buffer buf)
          (when (and (string-prefix-p "*" (buffer-name)) (string-suffix-p "*" (buffer-name)))
            (kill-buffer buf))
          ))))
#+end_src

** åŸºæœ¬è®¾ç½®
*** ç”¨æˆ·ä¿¡æ¯

#+begin_src elisp
  (setq user-full-name "xhcoding"
	user-mail-address "xhcoding@foxmail.com")
#+end_src

*** å¢åŠ  IO æ€§èƒ½

#+begin_src elisp
  (setq process-adaptive-read-buffering nil)
  (setq read-process-output-max (* 1024 1024))
#+end_src

*** è®¾ç½®ç¼–ç 

é»˜è®¤ä½¿ç”¨ utf-8 ï¼Œåœ¨ windows æ–‡ä»¶åç¼–ç ä½¿ç”¨ gbk ï¼Œä¸ç„¶æ‰“ä¸å¼€ä¸­æ–‡æ–‡ä»¶
#+begin_src elisp
  (prefer-coding-system 'utf-8)
  (when sys-is-windows
    (setq file-name-coding-system 'gbk))
#+end_src

python é»˜è®¤ä½¿ç”¨ UTF8 ç¼–ç 

#+begin_src elisp
  (setenv "PYTHONUTF8" "1")
#+end_src

*** è®¾ç½® frame æ ‡é¢˜

#+begin_src emacs-lisp
  (setq frame-title-format "Emacs")
#+end_src

*** å…³é—­å¯åŠ¨åŠ¨ç”»

#+begin_src elisp
  (setq inhibit-startup-message t)
#+end_src

*** scratch buffer è®¾ç½®

scratch ä¸º fundaemental-mode

#+begin_src elisp
(setq initial-major-mode 'fundamental-mode)
#+end_src

scratch buffer å†…å®¹ä¸ºç©º

#+begin_src elisp
  (setq initial-scratch-message nil)
#+end_src

*** yes-or-no-p æ”¹ä¸º y-or-n-p

#+begin_src elisp
  (setq use-short-answers t)
#+end_src

*** å…³æ‰æç¤ºå£°éŸ³

#+begin_src elisp
  (setq visible-bell t)
#+end_src

*** ç¦æ­¢å…‰æ ‡é—ªçƒ

#+begin_src elisp
  (blink-cursor-mode -1)
#+end_src

*** å¯åŠ¨æ—¶ä¸è¦æ˜¾ç¤º For information about GNU Emacs...

#+begin_src elisp
  (advice-add #'display-startup-echo-area-message :override #'ignore)
#+end_src

*** tab è®¾ç½®

#+begin_src elisp
  (setq-default tab-width 4)

  (setq-default indent-tabs-mode nil)
#+end_src

*** ä¸€è¡Œä¸è¶…è¿‡ 120 å­—ç¬¦

#+begin_src elisp
  (setq-default fill-column 120)
#+end_src

*** åˆ é™¤æ–‡ä»¶æ—¶æ”¾åˆ°å›æ”¶ç«™

#+begin_src elisp
(setq-default delete-by-moving-to-trash t)
#+end_src

*** é«˜äº®å½“å‰è¡Œ

#+begin_src elisp
(global-hl-line-mode +1)
#+end_src

** ä½¿ç”¨ gcmh ä¼˜åŒ–åƒåœ¾å›æ”¶

#+begin_src elisp
  (use-package gcmh
    :straight t
    :hook (emacs-startup . gcmh-mode)
    :init
    (setq gcmh-idle-delay 'auto
	  gcmh-auto-idle-delay-factor 10
	  gcmh-high-cons-threshold 33554432)) ; 32MB
#+end_src

** è‡ªåŠ¨ä¿å­˜ buffer
ref: https://github.com/manateelazycat/auto-save

#+begin_src elisp
  (use-package auto-save
    :straight (auto-save :type git :host github :repo "manateelazycat/auto-save")
    :defer 3
    :init
    ;; å…³é—­ emacs é»˜è®¤çš„è‡ªåŠ¨å¤‡ä»½
    (setq make-backup-files nil)
    ;; å…³é—­ emacs é»˜è®¤çš„ è‡ªåŠ¨ä¿å­˜
    (setq auto-save-default nil)
    :config
    (setq auto-save-silent t)
    (auto-save-enable)
    )


#+end_src

** rime è¾“å…¥æ³•

#+begin_src elisp
  (use-package rime
    :straight t
    :defer t
    :init
    (setq rime--module-path
	  (expand-file-name (concat "librime-emacs" module-file-suffix) my-lib-dir))
    (when sys-is-windows
      (setq rime-share-data-dir (expand-file-name "rime-data" my-etc-dir)))

    (defun my-*require-rime(&rest _)
      "Require rime when toggle-input-method."
      (unless (featurep 'rime)
	(require 'rime)))

    (advice-add 'toggle-input-method :before #'my-*require-rime)

    :custom
    (default-input-method "rime")
    (rime-show-candidate 'posframe)
    (rime-user-data-dir (expand-file-name "rime-user" my-etc-dir))

    :config
    (setq
     rime-disable-predicates '(meow-normal-mode-p
			       meow-motion-mode-p
			       meow-keypad-mode-p))
    )

#+end_src

** å­—ä½“å’Œä¸»é¢˜

#+begin_src elisp
  (set-face-attribute 'default nil :font "Cascadia Code PL" :height 120)

  (set-fontset-font t 'emoji (font-spec :family "Segoe UI Symbol"))

  (set-fontset-font t 'chinese-gbk (font-spec :family "å¾®è½¯é›…é»‘"))


  (use-package modus-themes
    :straight t
    :config
    (load-theme 'modus-operandi :no-confirm)
    )

#+end_src

** å›¾æ ‡å­—ä½“å®‰è£…

#+begin_src elisp
    (use-package all-the-icons
      :straight t)

#+end_src

** modeline è®¾ç½®

#+begin_src elisp
  (use-package doom-modeline
    :straight t
    :config (doom-modeline-mode +1))

#+end_src

** hydra æ–¹ä¾¿çš„å¿«æ·é”®è®¾ç½®

#+begin_src elisp
  (use-package hydra
    :straight t)

  (use-package pretty-hydra
    :straight t
    :after hydra
    :init
    (cl-defun pretty-hydra-title (title &optional icon-type icon-name
                                        &key face height v-adjust)
      "Add an icon in the hydra title."
      (let ((face (or face `(:foreground ,(face-background 'highlight))))
            (height (or height 1.0))
            (v-adjust (or v-adjust 0.0)))
        (concat
         (when (and icon-type icon-name)
           (let ((f (intern (format "all-the-icons-%s" icon-type))))
             (when (fboundp f)
               (concat
                (apply f (list icon-name :face face :height height :v-adjust v-adjust))
                " "))))
         (propertize title 'face face))))
    )

#+end_src

** è¯»å–æœ€è¿‘æ–‡ä»¶

#+begin_src elisp
  (use-package recentf
    :commands (recentf-open-files)
    :hook (after-init . recentf-mode)
    :init (setq recentf-max-saved-items 500
                recentf-exclude
                '("\\.?cache" ".cask" "url" "COMMIT_EDITMSG\\'" "bookmarks"
                  "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\|bmp\\|xpm\\)$"
                  "\\.?ido\\.last$" "\\.revive$" "/G?TAGS$" "/.elfeed/"
                  "^/tmp/" "^/var/folders/.+$" ; "^/ssh:"
                  (lambda (file) (file-in-directory-p file package-user-dir))))
    :config
    (push (expand-file-name recentf-save-file) recentf-exclude))

#+end_src

** æ›´æ–¹ä¾¿çš„å¼¹å‡ºçª—å£

#+begin_src elisp
  (use-package popper
    :straight t
    :hook (emacs-startup . popper-mode)
    :init
    (setq popper-reference-buffers
	  '(
	    help-mode
	    rustic-cargo-run-mode
	    lsp-bridge-ref-mode
	    ))
    :config

    (with-no-warnings
      (defun my-popper-fit-window-height (win)
	"Determine the height of popup window WIN by fitting it to the buffer's content."
	(fit-window-to-buffer
	 win
	 (floor (frame-height) 3)
	 (floor (frame-height) 3)))
      (setq popper-window-height #'my-popper-fit-window-height)

      (defun popper-close-window-hack (&rest _)
	"Close popper window via `C-g'."
	;; `C-g' can deactivate region
	(when (and (called-interactively-p 'interactive)
		   (not (region-active-p))
		   popper-open-popup-alist)
	  (let ((window (caar popper-open-popup-alist)))
	    (when (window-live-p window)
	      (delete-window window)))))
      (advice-add #'keyboard-quit :before #'popper-close-window-hack))
    )


#+end_src

** è‡ªåŠ¨åŒæ­¥å¤–éƒ¨æ–‡ä»¶æ”¹å˜

#+begin_src elisp
  (use-package autorevert
    :config
    (global-auto-revert-mode +1))

#+end_src

** minibuffer è¡¥å…¨åŠå¢å¼º

#+begin_src elisp
  (use-package orderless
    :straight t
    :custom (completion-styles '(orderless)))

  (use-package vertico
    :straight t
    :config
    (vertico-mode +1))

  (use-package marginalia
    :straight t
    :config
    (marginalia-mode +1))

  (use-package consult
    :straight t
    :commands (consult-customize)
    :init
    (consult-customize
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file
     consult--source-bookmark consult--source-recent-file
     :preview-key (kbd "M-."))
    :config
    (when sys-is-windows
      (add-to-list 'process-coding-system-alist '("es" gbk . gbk))
      (add-to-list 'process-coding-system-alist '("explorer" gbk . gbk))
      (setq consult-locate-args (encode-coding-string "es.exe -i -p -r" 'gbk)))

    (defun consult--fd-builder (input)
      (pcase-let* ((`(,arg . ,opts) (consult--command-split input))
		   (`(,re . ,hl) (funcall consult--regexp-compiler
					  arg 'extended t)))
	(when re
	  (list :command (append
			  (list "fd"
				"--color=never" "--full-path"
				(consult--join-regexps re 'extended))
			  opts)
		:highlight hl))))

    (defun consult-fd (&optional dir initial)
      (interactive "P")
      (let* ((prompt-dir (consult--directory-prompt "Fd" dir))
	     (default-directory (cdr prompt-dir)))
	(find-file (consult--find (car prompt-dir) #'consult--fd-builder initial))))
    )
#+end_src

** avy å¿«é€Ÿç§»åŠ¨å…‰æ ‡åˆ°å±å¹•ä¸Šä»»æ„å­—ç¬¦

#+begin_src elisp
  (use-package pinyinlib
    :straight t
    :defer t)

  (use-package avy
    :straight t
    :bind (("M-'" . my/avy-goto-char-timer))
    :init
    (defun my/avy-goto-char-timer (&optional arg)
      "Make avy-goto-char-timer support pinyin"
      (interactive "P")
      (require 'pinyinlib)
      (require 'avy)
      (let ((avy-all-windows (if arg
                                 (not avy-all-windows)
                               avy-all-windows)))
        (avy-with avy-goto-char-timer
          (setq avy--old-cands (avy--read-candidates
                                'pinyinlib-build-regexp-string))
          (avy-process avy--old-cands))))


    :config
    (setq avy-all-windows nil
          avy-all-windows-alt t
          avy-background t
          avy-style 'pre))
#+end_src

** ace-window å¿«é€Ÿåˆ‡æ¢åˆ°å…¶å®ƒ window

#+begin_src elisp
  (use-package ace-window
    :straight t
    :bind (("M-o" . ace-window)))
#+end_src

** å¿«é€Ÿåˆ‡æ¢åˆ°å•çª—å£

ref:https://github.com/manateelazycat/toggle-one-window

#+begin_src elisp
  (defvar my--window-configuration nil
    "The window configuration use for `toggle-one-window'.")

  (defun my/toggle-one-window ()
    "Toggle between window layout and one window."
    (interactive)
    (if (equal (length (cl-remove-if #'window-dedicated-p (window-list))) 1)
        (if my--window-configuration
            (progn
              (set-window-configuration my--window-configuration)
              (setq my--window-configuration nil))
          (message "No other windows exist."))
      (setq my--window-configuration (current-window-configuration))
      (delete-other-windows)))

  (global-set-key (kbd "M-;") #'my/toggle-one-window)
#+end_src

** ä»£ç ç‰‡æ®µ

#+begin_src elisp
  (use-package yasnippet
    :straight t
    :defer t
    :config
    (add-to-list 'yas-snippet-dirs my-private-snippets-dir)
    (yas-reload-all))

#+end_src

** project è®¾ç½®

#+begin_src elisp
  (use-package project
    :defer t
    :custom
    (project-switch-commands #'project-find-file)
    :config
    (defun my--project-files-in-directory (dir)
      "Use `fd' to list files in DIR."
      (let* ((default-directory dir)
             (localdir (file-local-name (expand-file-name dir)))
             (command (format "fd . --color=never --type f -0 -H -E .git --path-separator=/ %s" localdir)))
        (project--remote-file-names
         (sort (split-string (shell-command-to-string command) "\0" t)
               #'string<))))

    ;; (head vc) è¡¨ç¤ºå¯¹äºæ‰€æœ‰ vc é¡¹ç›®
    (cl-defmethod project-files ((project (head vc)) &optional dirs)
      "Override `project-files' to use `fd' in vc projects."
      (mapcan #'my--project-files-in-directory
              (or dirs (list (project-root project))))))


#+end_src

** lsp-bridge ä»£ç è¡¥å…¨

#+begin_src elisp

  (use-package markdown-mode
    :straight t
    :defer t)

  (use-package lsp-bridge
    :straight (lsp-bridge :type git :host github :repo "manateelazycat/lsp-bridge"
              :files ("*")
              :build nil)
    :defer t
    :hook ((lsp-bridge-mode . my-lsp-bridge--remap-xref))
    :init

    ;; æ‰‹åŠ¨æ·»åŠ åˆ° load-path
    (add-to-list 'load-path (straight--repos-dir "lsp-bridge"))

    (setq lsp-bridge-org-babel-lang-list nil)

    ;; https://tecosaur.github.io/emacs-config/config.html#lsp-support-src
    (cl-defmacro my-lsp-org-babel-enable (lang)
      "Support LANG in org source code block."
      (cl-check-type lang string)
      (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
         (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
    `(progn
       (defun ,intern-pre (info)
         (let ((file-name (->> info caddr (alist-get :file))))
           (unless file-name
         (setq file-name (expand-file-name "OrgBabel/org-src-babel" my-code-dir))
         (write-region (point-min) (point-max) file-name))
           (setq buffer-file-name file-name)
           (my-enable-lsp-bridge)))
       (put ',intern-pre 'function-documentation
        (format "Enable lsp-bridge-mode in the buffer of org source block (%s)."
            (upcase ,lang)))
       (if (fboundp ',edit-pre)
           (advice-add ',edit-pre :after ',intern-pre)
         (progn
           (defun ,edit-pre (info)
         (,intern-pre info))
           (put ',edit-pre 'function-documentation
            (format "Prepare local buffer environment for org source block (%s)."
                (upcase ,lang))))))))

    (with-eval-after-load 'org
      (dolist (lang '("c" "cpp" "python" "rust"))
    (eval `(my-lsp-org-babel-enable ,lang))))


    :config

    (push '(js-ts-mode . "javascript") lsp-bridge-single-lang-server-mode-list)
    (push '(typescript-ts-mode . "typescript") lsp-bridge-single-lang-server-mode-list)
    (push '(css-ts-mode . "vscode-css-language-server") lsp-bridge-single-lang-server-mode-list)
    (push '(scss-mode . "vscode-css-language-server") lsp-bridge-single-lang-server-mode-list)
    (push '(cmake-ts-mode . "cmake-language-server") lsp-bridge-single-lang-server-mode-list)

    (push '(qml-ts-mode . "qmlls_javascript") lsp-bridge-multi-lang-server-mode-list)

    (setq lsp-bridge-user-langserver-dir my-etc-dir
          lsp-bridge-user-multiserver-dir my-etc-dir)


    (setq acm-enable-tabnine nil
      acm-enable-quick-access t
      lsp-bridge-enable-hover-diagnostic t)

    (defun my-lsp-bridge--remap-xref()
      "Remap xref key bind when lsp-bridge-mode enable."
      (unless (eq major-mode 'emacs-lisp-mode)
    (local-set-key (kbd "M-.") #'lsp-bridge-find-def)
    (local-set-key (kbd "M-?") #'lsp-bridge-find-references)
    (local-set-key (kbd "M-,") #'lsp-bridge-find-def-return)
    ))
    )
#+end_src

å¯åŠ¨ lsp-bridge

#+begin_src elisp
  (defun my-enable-lsp-bridge()
    "Enable lsp bridge mode."
    (require 'yasnippet)
    (yas-minor-mode)
    (require 'lsp-bridge)
    ;; (when-let* ((project (project-current))
    ;;            (project-root (nth 2 project)))
    ;;   (setq-local lsp-bridge-user-langserver-dir project-root
    ;;               lsp-bridge-user-multiserver-dir project-root))
    (lsp-bridge-mode))


  (add-hook 'emacs-lisp-mode-hook #'my-enable-lsp-bridge)
#+end_src

** è¾“å…¥æˆå¯¹æ‹¬å·

#+begin_src elisp
  (use-package elec-pair
    :hook (after-init . electric-pair-mode)
    :init (setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit))
#+end_src

** é«˜äº®å¤–å±‚æ‹¬å·

#+begin_src elisp
  (use-package highlight-parentheses
    :straight t
    :hook (prog-mode . highlight-parentheses-mode))
#+end_src

** æ³¨é‡Šä»£ç 

#+begin_src elisp
  (use-package evil-nerd-commenter
    :straight t
    :bind ("C-/" . evilnc-comment-or-uncomment-lines))
#+end_src

** git é…ç½®

*** magit

#+begin_src elisp
  (use-package magit
    :straight t
    :bind ("C-x g" . magit-status)
    :config
    (when sys-is-windows
      (setenv "GIT_ASKPASS" "git-gui--askpass")))

  (use-package magit-todos
    :straight t
    :after magit
    :config
    (magit-todos-mode +1))


  (use-package ssh-agency
    :straight t
    :after magit)
#+end_src

*** æ˜¾ç¤ºå½“å‰è¡Œçš„æœ€åæäº¤ä¿¡æ¯

#+begin_src emacs-lisp
  (use-package git-messenger
    :straight t
    :bind (:map vc-prefix-map
           ("p" . git-messenger:popup-message)
           :map git-messenger-map
           ("m" . git-messenger:copy-message))
    :init
    (setq git-messenger:show-detail t
          git-messenger:use-magit-popup t)

    (defface posframe-border
      `((t (:inherit region)))
      "Face used by the `posframe' border."
      :group 'posframe)
    :config
    (with-no-warnings
      (with-eval-after-load 'hydra
        (defhydra git-messenger-hydra (:color blue)
          ("s" git-messenger:popup-show "show")
          ("c" git-messenger:copy-commit-id "copy hash")
          ("m" git-messenger:copy-message "copy message")
          ("," (catch 'git-messenger-loop (git-messenger:show-parent)) "go parent")
          ("q" git-messenger:popup-close "quit")))

      (defun my-git-messenger:format-detail (vcs commit-id author message)
        (if (eq vcs 'git)
            (let ((date (git-messenger:commit-date commit-id))
                  (colon (propertize ":" 'face 'font-lock-comment-face)))
              (concat
               (format "%s%s %s \n%s%s %s\n%s  %s %s \n"
                       (propertize "Commit" 'face 'font-lock-keyword-face) colon
                       (propertize (substring commit-id 0 8) 'face 'font-lock-comment-face)
                       (propertize "Author" 'face 'font-lock-keyword-face) colon
                       (propertize author 'face 'font-lock-string-face)
                       (propertize "Date" 'face 'font-lock-keyword-face) colon
                       (propertize date 'face 'font-lock-string-face))
               (propertize (make-string 38 ?â”€) 'face 'font-lock-comment-face)
               message
               (propertize "\nPress q to quit" 'face '(:inherit (font-lock-comment-face italic)))))
          (git-messenger:format-detail vcs commit-id author message)))

      (defun my-git-messenger:popup-message ()
        "Popup message with `posframe', `pos-tip', `lv' or `message', and dispatch actions with `hydra'."
        (interactive)
        (let* ((hydra-hint-display-type 'message)
               (vcs (git-messenger:find-vcs))
               (file (buffer-file-name (buffer-base-buffer)))
               (line (line-number-at-pos))
               (commit-info (git-messenger:commit-info-at-line vcs file line))
               (commit-id (car commit-info))
               (author (cdr commit-info))
               (msg (git-messenger:commit-message vcs commit-id))
               (popuped-message (if (git-messenger:show-detail-p commit-id)
                                    (my-git-messenger:format-detail vcs commit-id author msg)
                                  (cl-case vcs
                                    (git msg)
                                    (svn (if (string= commit-id "-")
                                             msg
                                           (git-messenger:svn-message msg)))
                                    (hg msg)))))
          (setq git-messenger:vcs vcs
                git-messenger:last-message msg
                git-messenger:last-commit-id commit-id)
          (run-hook-with-args 'git-messenger:before-popup-hook popuped-message)
          (git-messenger-hydra/body)
          (cond ((and (fboundp 'posframe-workable-p) (posframe-workable-p))
                 (let ((buffer-name "*git-messenger*"))
                   (posframe-show buffer-name
                                  :string (concat (propertize "\n" 'face '(:height 0.3))
                                                  popuped-message
                                                  "\n"
                                                  (propertize "\n" 'face '(:height 0.3)))
                                  :left-fringe 8
                                  :right-fringe 8
                                  :max-width (round (* (frame-width) 0.62))
                                  :max-height (round (* (frame-height) 0.62))
                                  :internal-border-width 1
                                  :internal-border-color (face-background 'posframe-border nil t)
                                  :background-color (face-background 'tooltip nil t))
                   (unwind-protect
                       (push (read-event) unread-command-events)
                     (posframe-hide buffer-name))))
                ((and (fboundp 'pos-tip-show) (display-graphic-p))
                 (pos-tip-show popuped-message))
                ((fboundp 'lv-message)
                 (lv-message popuped-message)
                 (unwind-protect
                     (push (read-event) unread-command-events)
                   (lv-delete-window)))
                (t (message "%s" popuped-message)))
          (run-hook-with-args 'git-messenger:after-popup-hook popuped-message)))
      (advice-add #'git-messenger:popup-close :override #'ignore)
      (advice-add #'git-messenger:popup-message :override #'my-git-messenger:popup-message)))
#+end_src

*** smerge-mode è§£å†³å†²çª

#+begin_src elisp
  (use-package smerge-mode
    :ensure nil
    :pretty-hydra
    ((:title (pretty-hydra-title "Smerge" 'octicon "diff")
             :color pink :quit-key "q")
     ("Move"
      (("n" smerge-next "next")
       ("p" smerge-prev "previous"))
      "Keep"
      (("b" smerge-keep-base "base")
       ("u" smerge-keep-upper "upper")
       ("l" smerge-keep-lower "lower")
       ("a" smerge-keep-all "all")
       ("RET" smerge-keep-current "current")
       ("C-m" smerge-keep-current "current"))
      "Diff"
      (("<" smerge-diff-base-upper "upper/base")
       ("=" smerge-diff-upper-lower "upper/lower")
       (">" smerge-diff-base-lower "upper/lower")
       ("R" smerge-refine "refine")
       ("E" smerge-ediff "ediff"))
      "Other"
      (("C" smerge-combine-with-next "combine")
       ("r" smerge-resolve "resolve")
       ("k" smerge-kill-current "kill")
       )))
    :bind (:map smerge-mode-map
                ("C-c m" . smerge-mode-hydra/body)))
#+end_src

** å¯è§†åŒ–çš„æ­£åˆ™æ›¿æ¢

#+begin_src elisp
  (use-package visual-regexp
    :straight t
    :defer t)
#+end_src

** é€’å¢é€‰åŒº

#+begin_src emacs-lisp
  (use-package expand-region
    :straight t
    :bind (("C-=" . er/expand-region))
    :config
    (defun treesit-mark-bigger-node ()
      (let* ((root (treesit-buffer-root-node))
             (node (treesit-node-descendant-for-range root (region-beginning) (region-end)))
             (node-start (treesit-node-start node))
             (node-end (treesit-node-end node)))
        ;; Node fits the region exactly. Try its parent node instead.
        (when (and (= (region-beginning) node-start) (= (region-end) node-end))
          (when-let ((node (treesit-node-parent node)))
            (setq node-start (treesit-node-start node)
                  node-end (treesit-node-end node))))
        (set-mark node-end)
        (goto-char node-start)))

    (add-to-list 'er/try-expand-list 'treesit-mark-bigger-node)
    )

#+end_src

** openwith å¤–éƒ¨å·¥å…·æ‰“å¼€æ–‡ä»¶

#+begin_src elisp
  (use-package openwith
    :straight t
    :custom
    (openwith-associations
     '(("\\.\\(doc\\|docs\\|xls\\|xlsx\\|ppt\\|pptx\\)$"
          "explorer.exe" (file))))
    :config
    (openwith-mode +1))
#+end_src

** å¯ç”¨ treesit

#+begin_src elisp
  (setq major-mode-remap-alist
		'((c-mode          . c-ts-mode)
		  (c++-mode        . c++-ts-mode)
		  (cmake-mode      . cmake-ts-mode)
		  (conf-toml-mode  . toml-ts-mode)
		  (csharp-mode     . csharp-ts-mode)
		  (css-mode        . css-ts-mode)
		  (dockerfile-mode . dockerfile-ts-mode)
		  (go-mode         . go-ts-mode)
		  (java-mode       . java-ts-mode)
		  (json-mode       . json-ts-mode)
		  (js-json-mode    . json-ts-mode)
		  (javascript-mode . js-ts-mode)
		  (python-mode     . python-ts-mode)
		  (rust-mode       . rust-ts-mode)
		  (sh-mode         . bash-ts-mode)
		  (typescript-mode . typescript-ts-mode)))
#+end_src

** C++ å¼€å‘é…ç½®

*** cmake-ts-mode è®¾ç½®

#+begin_src emacs-lisp
  (use-package cmake-ts-mode
    :hook (cmake-ts-mode . my-enable-lsp-bridge))
#+end_src

*** c-ts-mode è®¾ç½®

#+begin_src elisp
  (use-package c-ts-mode
    :hook (c++-ts-mode . my-enable-cc-dev)
    :custom
    (c-ts-mode-indent-offset  4)
    :config
    (defun my-enable-cc-dev()
      (setq-local lsp-bridge-completion-hide-characters '(";" "(" ")" "[" "]" "{" "}" "," "\""))
      (my-enable-lsp-bridge)
      )
    )
#+end_src

** Rust å¼€å‘é…ç½®

#+begin_src elisp
  (use-package rust-ts-mode
    :hook (rust-ts-mode . my-enable-lsp-bridge))
#+end_src

** python å¼€å‘é…ç½®

#+begin_src emacs-lisp
  (use-package python
    :hook (python-ts-mode . my-enable-lsp-bridge))
#+end_src

** web å¼€å‘

*** Javascript

#+begin_src elisp
  (use-package js
    :hook (js-ts-mode . my-enable-lsp-bridge)
    )
#+end_src

*** Typescript

#+begin_src emacs-lisp
  (use-package typescript-ts-mode
    :hook (typescript-ts-base-mode . my-enable-lsp-bridge))
#+end_src

*** HTML

#+begin_src emacs-lisp
  (use-package web-mode
    :straight t
    :mode "\\.\\(phtml\\|php\\|[gj]sp\\|as[cp]x\\|erb\\|djhtml\\|html?\\|hbs\\|ejs\\|jade\\|swig\\|tm?pl\\|vue\\)$"
    :hook (web-mode . my-enable-lsp-bridge)
    :custom
    (web-mode-markup-indent-offset 2)
    (web-mode-css-indent-offset 2)
    (web-mode-code-indent-offset 2)
    (web-mode-enable-auto-indentation nil)
    )
#+end_src

*** css


#+begin_src elisp
  (use-package css-mode
    :hook (css-ts-mode . my-enable-lsp-bridge)
    :custom
    (css-indent-offset 2))

  (use-package scss-mode
    :hook (scss-mode . my-enable-lsp-bridge))
#+end_src

** json-mode

#+begin_src elisp
  (use-package json-js-mode
    :defer t
    :custom
    (json-ts-mode-indent-offset 2))
#+end_src

** qml

#+begin_src elisp
  (use-package qml-ts-mode
    :straight (qml-ts-mode :type git :host github :repo "xhcoding/qml-ts-mode")
    :hook (qml-ts-mode . my-enable-lsp-bridge)
    :custom
    (qml-ts-mode-indent-offset 4))
#+end_src

** plantuml æ”¯æŒ

#+begin_src emacs-lisp
  (use-package plantuml-mode
    :straight t
    :defer t
    :custom
    (plantuml-jar-path (expand-file-name "plantuml.jar" my-lib-dir))
    (plantuml-default-exec-mode 'jar))
#+end_src

** dap-mode é…ç½®

#+begin_src elisp
  (use-package dap-mode
    :straight t
    :defer t
    :config

    ;; fix runInTerminal
    (defun dap--start-process (debug-session parsed-msg)
      (-let* (((&hash "arguments" (&hash? "args" "cwd" "title" "kind") "seq")
           parsed-msg)
          (default-directory cwd)
          (command-to-run (combine-and-quote-strings args " "))
          (kind (or kind dap-default-terminal-kind)))
    (or
     (when (string= kind "external")
       (let* ((name (or title (concat (dap--debug-session-name debug-session)
                      "- terminal")))
          (terminal-argv
           (cl-loop for part in dap-external-terminal collect
                (->> part (s-replace "{display}" name)
                 (s-replace "{command}" command-to-run)))))
         (when
         (condition-case-unless-debug err
             (progn (apply #'start-process name name terminal-argv) t)
           (error (lsp--warn
               "dap-debug: failed to start external
  terminal: %S (launch command was: \"%s\"). Set
  `dap-external-terminal' to the correct value or install the
  terminal configured (probably xterm)."
               (error-message-string err)
               (mapconcat #'shell-quote-argument terminal-argv " "))
              ;; we did *not* succeed; use the integrated terminal
              ;; instead
              nil))
           ;; NOTE: we cannot know the process id of the started
           ;; application.
           (dap--send-message (dap--make-success-response
                   seq "runInTerminal" (make-hash-table :test 'equal))
                  ;; NOTE: assuming that the terminal starts the
                  ;; application without another subshell
                  (dap--resp-handler) debug-session)
           ;; success; don't use the integrated terminal
           t)))
     ;; integrated terminal *or* the external terminal could not be executed
     ;; (file error).
     (when (or (string= kind "integrated") (string= kind "external"))
       (funcall dap-internal-terminal command-to-run title debug-session)
       ;; NOTE: we don't know the PID of the shell that ran the process and we
       ;; don't know the PID of the started process.
       (dap--send-message (dap--make-success-response seq "runInTerminal" (make-hash-table :test 'equal))
                  (dap--resp-handler) debug-session)
       ;; success
       t)
     (dap--send-message (dap--make-error-response
                 seq "runInTerminal" nil
                 (format "unknown terminal kind %s" kind))
                (dap--resp-handler) debug-session))))

      ;; codelldb
    (require 'dap-codelldb)

    (defun my-dap--get-program-from-cargo-config(conf)
      "Get program from cargo config."
      (when-let* ((cwd (plist-get conf :cwd))
          (cargo (plist-get conf :cargo))
          (args (plist-get cargo :args)))
    (let* ((default-directory cwd)
           (command (format "cargo %s --message-format=json" (mapconcat 'identity args " ")))
           (output (shell-command-to-string command))
           (lines (split-string output "\n"))
           (msg)
           (artifacts))
      (dolist (line lines)
        (setq msg (ignore-errors (json-parse-string line)))
        (when (and msg (string-equal (gethash "reason" msg) "compiler-artifact"))
          (let* ((target (gethash "target" msg))
             (is-binary (member "bin" (append (gethash "crate_types" target) nil)))
             (kind (gethash "kind" target))
             (is-build-script (member "custom-build" (append kind nil)))
             (profile-test (gethash "test" (gethash "profile" msg)))
             (name (gethash "name" target))
             (executable (gethash "executable" msg)))
        (when (or (and is-binary (not is-build-script)) profile-test)
          (push `(:filename ,executable :name ,name :kind ,(aref kind 0)) artifacts)))))

      (let* ((filter (plist-get cargo :filter))
         (filter-name (plist-get filter :name))
         (filter-kind (plist-get filter :kind))
         (filtered-artifacts))
        (if (not (and filter filter-name filter-kind))
        (setq filtered-artifacts (copy-tree artifacts))
          (dolist (artifact artifacts)
        (when (and (string= filter-name (plist-get artifact :name))
               (string= filter-kind (plist-get artifact :kind))
               )
          (push artifact filtered-artifacts)
          )))
        (if (length= filtered-artifacts 1)
        (plist-get (car filtered-artifacts) :filename)
          (message "Cargo artifact error, check launch.json.")
          nil)))))

    (defun my-dap--get-codelldb-params (conf)
      ""
      (let ((params (make-hash-table :test 'equal)))
    (puthash "evaluateForHovers" 't params)
    (puthash "commandCompletions" 't params)
    (when (plist-get conf :cargo)
      (puthash "sourceLanguages" (vector "rust") params)
      )
    (json-encode (json-encode params))))

    (defun dap-codelldb--populate-lldb (conf)
      "Populate CONF with the required arguments."
      (let ((debug-port (dap--find-available-port)))
    (-> conf
        (dap--put-if-absent :type "lldb")
        (dap--put-if-absent :host "localhost")
        (dap--put-if-absent :debugServer debug-port)
        (dap--put-if-absent :program-to-start
                (format "%s --port %s --params %s"
                    dap-codelldb-debug-program
                    debug-port
                    (my-dap--get-codelldb-params conf)
                    ))
        (dap--put-if-absent :cwd default-directory)
        (dap--put-if-absent :program (or (my-dap--get-program-from-cargo-config conf) (expand-file-name (read-file-name "Select file to debug: "))))
        )))

    (dap-register-debug-provider "lldb" 'dap-codelldb--populate-lldb)

    (add-hook 'dap-stopped-hook
          (lambda (arg) (call-interactively #'dap-hydra)))

    (dap-auto-configure-mode +1)

    )

#+end_src

ä¸‹é¢çš„ wrapper å¯ä»¥åœ¨ä¸å¯åŠ¨ lsp-mode çš„æƒ…å†µä¸‹é€šè¿‡ lsp-workspace-root è·å–æ­£ç¡®çš„å€¼

#+begin_src elisp
  (eval-and-compile
    (defun my--ensure-lsp-workspace-root()
      "Ensure `lsp-workspace-root' valid."
      (require 'lsp-mode)
      (unless (lsp-workspace-root)
        (let* ((session (lsp-session))
               (lsp-auto-guess-root t)
               (project-root (lsp-f-canonical (lsp--calculate-root session (buffer-file-name)))))
          (unless (-contains? (lsp-session-folders session) project-root)
            (cl-pushnew project-root (lsp-session-folders session))
            (lsp--persist-session session))
          ))))

  (defun my/dap-debug()
    "dap-debug wrapper."
    (interactive)
    (require 'dap-mode)
    (my--ensure-lsp-workspace-root)
    (call-interactively #'dap-debug)
    )
#+end_src

** org é…ç½®

*** org-mode ç¾åŒ–è®¾ç½®

#+begin_src elisp
  (use-package org
    :defer t
    :straight t
    :hook (org-mode . my--org-prettify-symbols)
    :custom-face
    ;; è®¾ç½®Org modeæ ‡é¢˜ä»¥åŠæ¯çº§æ ‡é¢˜è¡Œçš„å¤§å°
    (org-document-title ((t (:height 1.75 :weight bold))))
    (org-level-1 ((t (:height 1.2 :weight bold))))
    (org-level-2 ((t (:height 1.15 :weight bold))))
    (org-level-3 ((t (:height 1.1 :weight bold))))
    (org-level-4 ((t (:height 1.05 :weight bold))))
    (org-level-5 ((t (:height 1.0 :weight bold))))
    (org-level-6 ((t (:height 1.0 :weight bold))))
    (org-level-7 ((t (:height 1.0 :weight bold))))
    (org-level-8 ((t (:height 1.0 :weight bold))))
    (org-level-9 ((t (:height 1.0 :weight bold))))
    ;; è®¾ç½®ä»£ç å—ç”¨ä¸Šä¸‹è¾¹çº¿åŒ…è£¹
    (org-block-begin-line ((t (:underline t :background unspecified))))
    (org-block-end-line ((t (:overline t :underline nil :background unspecified))))

    :custom
    ;; æ ‡é¢˜è¡Œç¾åŒ–
    (org-fontify-whole-heading-line t)
    ;; è®¾ç½®æ ‡é¢˜è¡ŒæŠ˜å ç¬¦å·
    (org-ellipsis " â–¾")
    ;; TODOæ ‡ç­¾ç¾åŒ–
    (org-fontify-todo-headline t)
    ;; DONEæ ‡ç­¾ç¾åŒ–
    (org-fontify-done-headline t)
    ;; å¼•ç”¨å—ç¾åŒ–
    (org-fontify-quote-and-verse-blocks t)
    ;; éšè—å®æ ‡è®°
    (org-hide-macro-markers t)
    ;; éšè—å¼ºè°ƒæ ‡ç­¾
    (org-hide-emphasis-markers t)
    ;; é«˜äº®latexè¯­æ³•
    (org-highlight-latex-and-related '(native script entities))
    ;; ä»¥UTF-8æ˜¾ç¤º
    (org-pretty-entities t)
    ;; å½“å¯ç”¨ç¼©è¿›æ¨¡å¼æ—¶è‡ªåŠ¨éšè—å‰ç½®æ˜Ÿå·
    (org-indent-mode-turns-on-hiding-stars t)
    ;; è‡ªåŠ¨å¯ç”¨ç¼©è¿›
    (org-startup-indented nil)
    ;; æ ¹æ®æ ‡é¢˜æ è‡ªåŠ¨ç¼©è¿›æ–‡æœ¬
    (org-adapt-indentation nil)
    ;; è‡ªåŠ¨æ˜¾ç¤ºå›¾ç‰‡
    (org-startup-with-inline-images t)
    ;; é»˜è®¤ä»¥Overviewçš„æ¨¡å¼å±•ç¤ºæ ‡é¢˜è¡Œ
    (org-startup-folded 'overview)
    ;; å…è®¸å­—æ¯åˆ—è¡¨
    (org-list-allow-alphabetical t)
    ;; ç¼–è¾‘æ—¶æ£€æŸ¥æ˜¯å¦åœ¨æŠ˜å çš„ä¸å¯è§åŒºåŸŸ
    (org-fold-catch-invisible-edits 'smart)
    ;; ä¸Šæ ‡^ä¸‹æ ‡_æ˜¯å¦éœ€è¦ç‰¹æ®Šå­—ç¬¦åŒ…è£¹ï¼Œè¿™é‡Œè®¾ç½®éœ€è¦ç”¨å¤§æ‹¬å·åŒ…è£¹
    (org-use-sub-superscripts '{})
    :config

    (defun my--org-prettify-symbols ()
      (setq prettify-symbols-alist
            (mapcan (lambda (x) (list x (cons (upcase (car x)) (cdr x))))
                    '(
                      ("#+begin_src"                        . ?âœ)
                      ("#+end_src"                          . ?â–¡)
                      ("#+results:"                         . ?ğŸ’»)
                      ("#+date:"                            . ?ğŸ“…)
                      ("#+author:"                          . ?ğŸ‘¤)
                      ("#+title:"                           . ?ğŸ““)
                      ("#+hugo_tags:"                       . ?ğŸ“)
                      ("#+hugo_categories"                  . ?ğŸ“)
                      ("#+hugo_locale"                      . ?ğŸŒ)
                      ("#+hugo_draft"                       . ?ğŸš®)
                      ("#+hugo_custom_front_matter"         . ?ğŸ“)
                      ("#+begin_quote"                      . ?Â«)
                      ("#+end_quote"                        . ?Â»)
                      )))
      (setq prettify-symbols-unprettify-at-point t)
      (prettify-symbols-mode 1))

    ;; ä¸­æ–‡å¼ºè°ƒæ ‡è®°å¯ç”¨
    (setcar (nthcdr 0 org-emphasis-regexp-components) " \t('\"{[:nonascii:]")
    (setcar (nthcdr 1 org-emphasis-regexp-components) "- \t.,:!?;'\")}\\[[:nonascii:]")
    (org-set-emph-re 'org-emphasis-regexp-components org-emphasis-regexp-components)
    (org-element-update-syntax)


    ;; è®¾ç½®æ ‡é¢˜è¡Œä¹‹é—´æ€»æ˜¯æœ‰ç©ºæ ¼ï¼›åˆ—è¡¨ä¹‹é—´æ ¹æ®æƒ…å†µè‡ªåŠ¨åŠ ç©ºæ ¼
    (setq org-blank-before-new-entry '((heading . t)
                                       (plain-list-item . auto)
                                       ))
    )

  (use-package org-modern
    :straight t
    :hook (org-mode . org-modern-mode)
    :config
    ;; é¢å¤–çš„è¡Œé—´è·ï¼Œ0.1è¡¨ç¤º10%ï¼Œ1è¡¨ç¤º1px
    (setq-default line-spacing 0.1)
    ;; tagè¾¹æ¡†å®½åº¦ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸º `auto' å³è‡ªåŠ¨è®¡ç®—
    (setq org-modern-label-border 1)
    ;; è®¾ç½®è¡¨æ ¼ç«–çº¿å®½åº¦ï¼Œé»˜è®¤ä¸º3
    (setq org-modern-table-vertical 2)
    ;; è®¾ç½®è¡¨æ ¼æ¨ªçº¿ä¸º0ï¼Œé»˜è®¤ä¸º0.1
    (setq org-modern-table-horizontal 0)
    ;; å¤é€‰æ¡†ç¾åŒ–
    (setq org-modern-checkbox
          '((?X . #("â–¢âœ“" 0 2 (composition ((2)))))
            (?- . #("â–¢â€“" 0 2 (composition ((2)))))
            (?\s . #("â–¢" 0 1 (composition ((1)))))))
    ;; åˆ—è¡¨ç¬¦å·ç¾åŒ–
    (setq org-modern-list
          '((?- . "â€¢")
            (?+ . "â—¦")
            (?* . "â–¹")))
    ;; ä»£ç å—ç±»å‹ç¾åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `prettify-symbols-mode'
    (setq org-modern-block-name nil)
    ;; #+å…³é”®å­—ç¾åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `prettify-symbols-mode'
    (setq org-modern-keyword nil)
    )

  (use-package org-appear
    :straight t
    :hook (org-mode . org-appear-mode)
    :config
    (setq org-appear-autolinks t)
    (setq org-appear-autosubmarkers t)
    (setq org-appear-autoentities t)
    (setq org-appear-autokeywords t)
    (setq org-appear-inside-latex t)
    )
#+end_src

*** org åŸºæœ¬é…ç½®

#+begin_src elisp
  (use-package org
    :defer t
    :straight t
    :bind (:map org-mode-map
                ("<" . my/insert-org-template))
    :custom
    (org-directory my-org-dir)
    :config
    ;; For hydra
    (defun hot-expand (str &optional mod)
      "Expand org template.
  STR is a structure template string recognised by org like <s. MOD is a
  string with additional parameters to add the begin line of the
  structure element. HEADER string includes more parameters that are
  prepended to the element after the #+HEADER: tag."
      (let (text)
        (when (region-active-p)
          (setq text (buffer-substring (region-beginning) (region-end)))
          (delete-region (region-beginning) (region-end)))
        (insert str)
        (if (fboundp 'org-try-structure-completion)
            (org-try-structure-completion) ; < org 9
          (progn
            ;; New template expansion since org 9
            (require 'org-tempo nil t)
            (org-tempo-complete-tag)))
        (when mod (insert mod) (forward-line))
        (when text (insert text))))

    (defun my/insert-org-template()
      "Insert org template"
      (interactive)
      (if (or (region-active-p) (looking-back "^\s*" 1))
          (org-hydra/body)
        (self-insert-command 1)))

    :pretty-hydra
    ;; See `org-structure-template-alist'
    ((:title (pretty-hydra-title "Org Template" 'fileicon "org" :face 'all-the-icons-green :height 1.1 :v-adjust 0.0)
             :color blue :quit-key ("q" "C-g"))
     ("Basic"
      (("a" (hot-expand "<a") "ascii")
       ("c" (hot-expand "<c") "center")
       ("C" (hot-expand "<C") "comment")
       ("e" (hot-expand "<e") "example")
       ("E" (hot-expand "<E") "export")
       ("h" (hot-expand "<h") "html")
       ("l" (hot-expand "<l") "latex")
       ("n" (hot-expand "<n") "note")
       ("o" (hot-expand "<q") "quote")
       ("v" (hot-expand "<v") "verse"))
      "Head"
      (("i" (hot-expand "<i") "index")
       ("A" (hot-expand "<A") "ASCII")
       ("I" (hot-expand "<I") "INCLUDE")
       ("H" (hot-expand "<H") "HTML")
       ("L" (hot-expand "<L") "LaTeX"))
      "Source"
      (("s" (hot-expand "<s") "src")
       ("m" (hot-expand "<s" "emacs-lisp") "emacs-lisp")
       ("y" (hot-expand "<s" "python :results output") "python")
       ("p" (hot-expand "<s" "perl") "perl")
       ("w" (hot-expand "<s" "powershell") "powershell")
       ("r" (hot-expand "<s" "ruby") "ruby")
       ("S" (hot-expand "<s" "sh") "sh")
       ("g" (hot-expand "<s" "go :imports '\(\"fmt\"\)") "golang"))
      "Misc"
      (("u" (hot-expand "<s" "plantuml :file CHANGE.png") "plantuml")
       ("Y" (hot-expand "<s" "ipython :session :exports both :results raw drawer\n$0") "ipython")
       ("P" (progn
              (insert "#+HEADERS: :results output :exports both :shebang \"#!/usr/bin/env perl\"\n")
              (hot-expand "<s" "perl")) "Perl tangled")
       ("<" self-insert-command "ins"))))
    )
#+end_src

*** org babel è®¾ç½®

#+begin_src elisp
  (use-package org
    :defer t
    :straight t
    :custom
    (org-confirm-babel-evaluate nil)
    (org-export-use-babel nil)
    :config
    (org-babel-do-load-languages 'org-babel-load-languages
                                 '((emacs-lisp . t)
                                   (perl . t)
                                   (python . t)
                                   (ruby . t)
                                   (js . t)
                                   (css . t)
                                   (sass . t)
                                   (C . t)
                                   (java . t)
                                   (plantuml . t)))
    ;; C æ‰§è¡Œæ”¯æŒ :stdin æ•°æ®
    (defun my*org-babel-execute-add-stdin(args)
      (let* ((body (nth 0 args))
             (params (nth 1 args))
             (stdin (cdr (assq :stdin params)))
             (cmdline (cdr (assq :cmdline params)))
             (stdin-file (expand-file-name "input_data.txt" (temporary-file-directory)))
             (data))
        (when stdin
          (setq data
                (save-excursion
                  (org-babel-goto-named-src-block stdin)
                  (org-element-property :value (org-element-at-point))))
          (with-temp-file stdin-file
            (insert data))
          (setq cmdline (concat (or cmdline "") " < " stdin-file))
          (setf (alist-get :cmdline params) cmdline))
        `(,body ,params)
        ))
    (advice-add #'org-babel-C-execute :filter-args 'my*org-babel-execute-add-stdin)

    )
#+end_src

*** gtd é…ç½®

#+begin_src elisp
  (use-package org
    :defer t
    :straight t
    :bind (("C-c a" . org-agenda)
           ("C-c c" . org-capture))
    :init
    (setq my-org-inbox-file (expand-file-name "gtd/inbox.org" my-org-dir))
    (setq my-org-projects-file (expand-file-name "gtd/projects.org" my-org-dir))

    (defun my--verify-refile-target ()
      "Exclude todo keywords with a done state from refile targets"
      (not (member (nth 2 (org-heading-components)) org-done-keywords)))

    :custom
    (org-agenda-files `(,my-org-inbox-file ,my-org-projects-file))
    (org-capture-templates `(("i" "Inbox" entry
                              (file ,my-org-inbox-file)
                              ,(concat "* TODO %?\n"
                                       "/Entered on/ %U"))))
    (org-todo-keywords
     '((sequence "TODO(t)" "NEXT(n)" "HOLD(h)" "|" "DONE(d)" "CANCELLED(c)")))

    ;; refile
    (org-refile-targets '((nil :maxlevel . 9)
                          (org-agenda-files :maxlevel . 9)))

    (org-refile-use-outline-path t)
    (org-outline-path-complete-in-steps nil)
    (org-refile-allow-creating-parent-nodes 'confirm)
    (org-refile-target-verify-function 'my--verify-refile-target)

    ;; agenda

    (org-agenda-span 'day)
    (org-agenda-hide-tags-regexp ".")
    (org-agenda-prefix-format
        '((agenda . " %i %-12:c%?-12t% s")
          (todo   . " ")
          (tags   . " %i %-12:c")
          (search . " %i %-12:c")))

    (org-agenda-custom-commands
        '(("g" "Get Things Done (GTD)"
           ((agenda ""
                    ((org-agenda-skip-function
                      '(org-agenda-skip-entry-if 'deadline))
                     (org-deadline-warning-days 0)))
            (todo "NEXT"
                  ((org-agenda-skip-function
                    '(org-agenda-skip-entry-if 'deadline))
                   (org-agenda-prefix-format "  %i %-12:c ")
                   (org-agenda-overriding-header "\nTasks\n")))
            (agenda nil
                    ((org-agenda-entry-types '(:deadline))
                     (org-agenda-format-date "")
                     (org-deadline-warning-days 7)
                     (org-agenda-skip-function
                      '(org-agenda-skip-entry-if 'notregexp "\\* NEXT"))
                     (org-agenda-overriding-header "\nDeadlines")))
            (tags-todo "inbox"
                       ((org-agenda-prefix-format "  %?-12t% s")
                        (org-agenda-overriding-header "\nInbox\n")))
            (tags "CLOSED>\"<today>\""
                  ((org-agenda-overriding-header "\nCompleted today\n")))))))



    )
#+end_src

*** export è®¾ç½®

#+begin_src emacs-lisp
  (use-package org
    :straight t
    :defer t
    :hook (org-mode . my--set-org-html-head-extra)
    :config
    (defun my--set-org-html-head-extra ()
      "Set org html head extra"
      (let ((path (expand-file-name "custom-head.html" my-etc-dir)))
        (when (file-exists-p path)
          (setq org-html-head-extra (with-temp-buffer
                                      (insert-file-contents path)
                                      (buffer-string))))))
    )
#+end_src

** çŸ¥è¯†ç®¡ç†åŠåšå®¢é…ç½®

*** org-roam

#+begin_src emacs-lisp
  (use-package emacsql-sqlite-builtin
    :straight t
    :defer t)

  (use-package org-roam
    :straight t
    :custom
    (org-roam-directory (expand-file-name "org-roam" my-org-dir))
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n g" . org-roam-graph)
           ("C-c n i" . org-roam-node-insert)
           ("C-c n c" . org-roam-capture)
           ;; Dailies
           ("C-c n j" . org-roam-dailies-capture-today))
    :init
    (setq org-roam-v2-ack t)
    (setq org-roam-database-connector 'sqlite-builtin)
    :config
    (org-roam-setup)

    (setq org-roam-capture-templates
          '(("d" "default" plain "%?"
             :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                                "
  ,#+title: ${title}
  ,#+date: %<%Y-%m-%d>
  ,#+author: xhcoding
  ,#+hugo_custom_front_matter: :isCJKLanguage true
  ,#+hugo_tags:
  ,#+hugo_categories:
  ,#+hugo_draft: false
  ")
             :unnarrowed t)))
    )


#+end_src

*** hugo é…ç½®

#+begin_src emacs-lisp
  ;; åšå®¢ç›¸å…³é…ç½®
  (defconst my-blog-root-dir
    "~/Blog/"
    "Blog root directory.")

  (defconst my-blog-img-dir
    (expand-file-name "images/" my-archives-dir)
    "Blog's image directory.")

  (defconst my-blog-res-url
    "https://images.xhcoding.cn/blog/"
    "Blog's source address.")

  (defconst my-blog-post-url
    "https://xhcoding.cn/post/"
    "Blog's post address.")

  (use-package ox-hugo
    :straight t
    :after org
    :custom
    (org-hugo-base-dir my-blog-root-dir)
    (org-hugo-section "post")
    (org-hugo-default-section-directory "post")
    (org-hugo-auto-set-lastmod t)
    :config
    (defun my-blog--blog-image-file-path-p (raw-path)
      (let ((file-path (expand-file-name raw-path)))
        (equal (string-match-p (regexp-quote (expand-file-name my-blog-img-dir)) file-path) 0)))

    ;; ~/Documents/Blog/images/1.png ==> https://images.xhcoding.cn/1.png

    (defun my-blog--convert-image-url (raw-path)
      (let ((file-path (expand-file-name raw-path)))
        (concat my-blog-res-url (string-trim-left file-path my-blog-img-dir))))

    ;; id:xxxxxx ==> https://xhcoding.cn/post/aaaaa
    (defun my-blog--convert-publish-url (id)
      (let ((file-name (file-name-base (org-roam-node-file (org-roam-node-from-id id)))))
        (concat my-blog-post-url file-name)))

    ;; ~/Documents/Blog/images/1.png ==> https://images.xhcoding.cn/1.png
    ;; id:xxxxxx ==> https://xhcoding.cn/post/aaaaa
    (defun my-blog*export-blog-url (args)
      (let* ((link (nth 0 args))
             (desc (nth 1 args))
             (info (nth 2 args))
             (type (org-element-property :type link))
             (raw-path (org-element-property :path link)))
        (cond
         ((and (string-equal type "file") (my-blog--blog-image-file-path-p raw-path))
          (progn
            (let* ((image-url (my-blog--convert-image-url raw-path))
                   (new-link (org-element-put-property link :path image-url )))
              `(,new-link ,desc ,info))))
         ((string-equal type "id")
          (progn
            (let* ((post-url (my-blog--convert-publish-url raw-path))
                   (new-link))
              (setq new-link (org-element-put-property link :path post-url))
              (setq new-link (org-element-put-property new-link :type "file"))
              `(,new-link ,desc, info))))
         (t `(,link ,desc ,info))
         )))

    (advice-add #'org-hugo-link :filter-args #'my-blog*export-blog-url)

    ;; front matter author => authors
    (defun my-blog*convert-author-to-authors(front-matter)
      "Convert author to authors."
      (let ((ret (replace-regexp-in-string "author" "authors" front-matter)))
        ret))

    (advice-add #'org-hugo--get-front-matter :filter-return #'my-blog*convert-author-to-authors)
    )

  (use-package easy-hugo
    :straight t
    :defer t
    :config
    (require 'org-roam)
    (setq easy-hugo-basedir (expand-file-name my-blog-root-dir)
          easy-hugo-postdir (expand-file-name org-roam-directory)
          easy-hugo-org-header t
          easy-hugo-github-deploy-script "deploy.bat"))

#+end_src

*** ä¸Šä¼ åšå®¢å›¾ç‰‡åˆ°è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨

#+begin_src emacs-lisp
  (defun my-blog/upload-images-to-tencent-cos ()
    "Upload blog images dir to tencent cos."
    (interactive)
    (call-process-shell-command
     (concat
      "coscmd upload -rs "
      my-blog-img-dir
      " blog/"
      )))

#+end_src

*** è‡ªåŠ¨åœ¨ä¸­è‹±æ–‡æ’å…¥ç©ºæ ¼

#+begin_src elisp
  (use-package pangu-spacing
    :straight t
    :after org
    :hook (org-mode . pangu-spacing-mode)
    :custom
    (pangu-spacing-real-insert-separtor t))
#+end_src

*** org-download ä¸‹è½½å›¾ç‰‡

#+begin_src elisp
  (use-package org-download
    :straight t
    :after org
    :config
    (when sys-is-windows
      (setq org-download-screenshot-method "irfanview /capture=4 /convert=\"%s\""
            org-download-display-inline-images 'posframe
            org-download-abbreviate-filename-function 'expand-file-name))
    (setq-default org-download-image-dir my-blog-img-dir
                  org-download-heading-lvl 2)
    (defun my/org-download-clipboard()
      "Download from clipboard"
      (interactive)
      (let ((org-download-screenshot-method "irfanview /clippaste /convert=\"%s\""))
        (org-download-screenshot))))


#+end_src

** eaf é…ç½®

#+begin_src elisp
  (use-package eaf
    :straight (emacs-application-framework :type git :host github :repo "emacs-eaf/emacs-application-framework"
                          :files ("*")
                          :build nil)
    :defer t
    :commands (eaf-open eaf-open-browser eaf-open-this-buffer)
    :init
    ;; æ‰‹åŠ¨æ·»åŠ åˆ° load-path
    (add-to-list 'load-path (straight--repos-dir "emacs-application-framework"))
    :config
    (setq eaf-webengine-default-zoom 2.5)
    (require 'eaf-browser)
    (require 'eaf-pdf-viewer)
    (require 'eaf-org-previewer)
    (require 'eaf-markdown-previewer)
    )

#+end_src

** æŒ‰é”®æç¤º

#+begin_src elisp
  (use-package which-key
    :straight t
    :hook (after-init . which-key-mode))
#+end_src

** å¸è½½é»˜è®¤çš„é”®ç»‘å®š

ref: https://github.com/manateelazycat/lazy-load

#+begin_src elisp
  (defun lazy-load-unset-keys (key-list &optional keymap)
    "This function is to little type when unset key binding.
  `KEYMAP' is add keymap for some binding, default is `current-global-map'
  `KEY-LIST' is list contain key."
    (let (key)
      (or keymap (setq keymap (current-global-map)))
      (dolist (key key-list)
	(cond ((stringp key) (setq key (read-kbd-macro (concat key))))
	      ((vectorp key) nil)
	      (t (signal 'wrong-type-argument (list 'array key))))
	(define-key keymap key nil))))

  (lazy-load-unset-keys
   '("C-s"
     "C-x b"
     ))
#+end_src

** meow æ¨¡å¼ç¼–è¾‘

#+begin_src elisp
  (use-package meow
    :straight t
    :demand t
    :hook (after-init . meow-global-mode)
    :config
    (setq meow-cheatsheet-layout meow-cheatsheet-layout-qwerty)

    (setq meow-char-thing-table
          '((?r . round)
            (?c . curly)
            (?s . string)
            (?b . buffer)
            (?d . defun)))

    (setq meow-use-clipboard t)

    (meow-leader-define-key
     ;; Use SPC (0-9) for digit arguments.
     '("1" . meow-digit-argument)
     '("2" . meow-digit-argument)
     '("3" . meow-digit-argument)
     '("4" . meow-digit-argument)
     '("5" . meow-digit-argument)
     '("6" . meow-digit-argument)
     '("7" . meow-digit-argument)
     '("8" . meow-digit-argument)
     '("9" . meow-digit-argument)
     '("0" . meow-digit-argument)
     '("?" . meow-cheatsheet)

     '("f" . consult-fd)
     '("b" . consult-buffer)
     '("r" . consult-ripgrep)
     '("s" . consult-line)

     '("/" . evilnc-comment-or-uncomment-lines)

     '("w3" . split-window-right)
     '("w0" . delete-other-windows)
     )

    (meow-normal-define-key
     ;; char move
     '("j" . meow-next)
     '("J" . meow-next-expand)
     '("k" . meow-prev)
     '("K" . meow-prev-expand)
     '("l" . meow-right)
     '("L" . meow-right-expand)
     '("h" . meow-left)
     '("H" . meow-left-expand)

     ;; word move
     '("e" . meow-next-word)
     '("E" . meow-next-symbol)
     '("b" . meow-back-word)
     '("B" . meow-back-symbol)

     ;; line move
     '("x" . meow-line)
     '("X" . meow-goto-line)

     ;; thing move
     '("," . meow-inner-of-thing)
     '("." . meow-bounds-of-thing)
     '("[" . meow-beginning-of-thing)
     '("]" . meow-end-of-thing)
     '("o" . meow-block)
     '("O" . meow-to-block)

     ;; jump
     '("n" . meow-search)
     '("f" . meow-find)
     '("v" . meow-visit)

     ;; action
     '("i" . meow-insert)
     '("I" . meow-open-above)
     '("a" . meow-append)
     '("A" . meow-open-below)
     '("y" . meow-save)
     '("Y" . meow-sync-grab)
     '("c" . meow-change)
     '("r" . meow-replace)
     '("R" . meow-swap-grab)
     '("p" . meow-yank)
     '("s" . meow-kill)
     '("d" . meow-delete)
     '("D" . meow-backward-delete)
     '("G" . meow-grab)
     '("m" . meow-join)
     '("t" . meow-till)
     '("u" . undo)
     '("U" . meow-undo)
     '("w" . meow-mark-word)
     '("W" . meow-mark-symbol)
     '("z" . meow-pop-selection)

     ;; others
     '("0" . meow-expand-0)
     '("9" . meow-expand-9)
     '("8" . meow-expand-8)
     '("7" . meow-expand-7)
     '("6" . meow-expand-6)
     '("5" . meow-expand-5)
     '("4" . meow-expand-4)
     '("3" . meow-expand-3)
     '("2" . meow-expand-2)
     '("1" . meow-expand-1)
     '("-" . negative-argument)
     '(";" . meow-reverse)
     '("g" . meow-cancel-selection)
     '("q" . meow-quit)
     '("'" . repeat)
     '("<escape>" . ignore)
     )
    )
#+end_src

** å¯åŠ¨ emacs server

#+begin_src elisp
  (setq server-name "emacs-server-file")
  (ignore-errors
    (server-start))
#+end_src

** å°†è¾“å…¥æ³•åˆ‡æ¢åˆ°è‹±æ–‡

#+begin_src elisp
  (when sys-is-windows
    (start-process "im-select" nil "im-select" "1033"))
#+end_src
